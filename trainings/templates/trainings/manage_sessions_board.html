{% extends "trainings/base.html" %}
{% load trainings_extras %}
{% block title %}G√©rer les formations{% endblock %}

{% block content %}
<div style="
  position: fixed;
  inset: 0;
  padding: 92px 18px 18px;
  box-sizing: border-box;
  overflow: hidden;
  color: rgba(255,255,255,0.92);
  background:
    radial-gradient(1200px 600px at 18% -10%, rgba(21,96,130,0.25), transparent 55%),
    radial-gradient(1000px 600px at 86% 10%, rgba(255,137,233,0.14), transparent 55%),
    linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00)),
    #0B0F14;
">

  <style>
    .panel{
      border-radius:18px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border: 1px solid rgba(255,255,255,0.07);
      backdrop-filter: blur(14px);
      box-shadow: 0 18px 45px rgba(0,0,0,0.55);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 0;
    }
    .ph{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex:0 0 auto;
    }
    .small{ font-size:13px; opacity:.7; }

    .btn{
      text-decoration:none;
      padding:9px 12px;
      border-radius:12px;
      border:1px solid rgba(124,58,237,0.45);
      background: rgba(124,58,237,0.18);
      color:white;
      font-weight:900;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn--ghost{
      border-color: rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
    }

    .select, .input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.12);
      color:white;
      font-weight:900;
      outline:none;
      box-sizing:border-box;
    }

    .grid{
      height: 100%;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
      min-height: 0;
    }
    @media(max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .scroll{
      overflow:auto;
      flex:1 1 auto;
      min-height:0;
      scrollbar-width: thin;
    }
    .scroll::-webkit-scrollbar{ width: 10px; }
    .scroll::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,0.16);
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,0.25);
    }
    .scroll::-webkit-scrollbar-track{
      background: rgba(255,255,255,0.04);
      border-radius: 999px;
    }

    /* ‚úÖ Mois : wrap (pas de scrollbar) */
    .monthbar{
      display:flex;
      gap:8px;
      flex-wrap: wrap;
      overflow: hidden;
      padding-bottom: 2px;
    }
    .pill{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.90);
      font-weight: 900;
      font-size: 12px;
      text-decoration:none;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .pill--sm{
      padding:6px 9px;
      font-size: 11px;
      letter-spacing: .4px;
      min-width: 44px;
      text-align:center;
    }
    .pill:hover{ filter: brightness(1.08); }
    .pill--active{
      border-color: rgba(124,58,237,0.45);
      background: rgba(124,58,237,0.18);
    }

    /* ‚úÖ 3 dropdown c√¥te √† c√¥te */
    .filters-row{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    @media(max-width: 980px){
      .filters-row{ grid-template-columns: 1fr; }
    }

    .tag{
      display:inline-flex;
      align-items:center;
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:950;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      margin-left:8px;
    }
    .tag--danger{ border-color: rgba(239,68,68,0.45); background: rgba(239,68,68,0.12); }
    .tag--warning{ border-color: rgba(245,158,11,0.45); background: rgba(245,158,11,0.12); }
    .tag--ok{ border-color: rgba(34,197,94,0.40); background: rgba(34,197,94,0.10); }

    .srow{
      padding:10px 12px;
      border-radius:14px;
      background: rgba(0,0,0,0.20);
      border:1px solid rgba(255,255,255,0.10);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      text-decoration:none;
      color:inherit;
    }
    .srow:hover{
      border-color: rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.24);
    }
    .srow--active{
      border-color: rgba(124,58,237,0.55) !important;
      background: rgba(124,58,237,0.12) !important;
    }
    .sname{
      font-weight:950;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:44ch;
    }
    .smeta{
      font-size:12px;
      opacity:.72;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:72ch;
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }

    .countbadge{
      flex:0 0 auto;
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:950;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      opacity:.95;
    }

    .prow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(0,0,0,0.20);
      border:1px solid rgba(255,255,255,0.10);
    }
    .pname{ font-weight:950; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:34ch; }
    .pemail{ font-size:12px; opacity:.72; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:44ch; }

    .iconbtn{
      width:38px;
      height:38px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color:white;
      text-decoration:none;
      cursor:pointer;
    }
    .iconbtn--danger{
      border-color: rgba(239,68,68,0.40);
      background: rgba(239,68,68,0.15);
    }
  </style>

  <div class="grid">

    <!-- COL GAUCHE -->
    <div class="panel">
      <div class="ph">
        <div>
          <div style="font-size:18px; font-weight:950;">
            üìö Sessions <span class="small" style="font-weight:900;">({{ sessions_count }})</span>
          </div>
          <div class="small">Mois / client / formateur / statut + recherche</div>
        </div>
      </div>

      <div style="padding:14px 16px; display:grid; gap:10px; flex:0 0 auto;">

        <!-- Recherche -->
        <form method="get" style="display:flex; gap:10px; align-items:center;">
          <input type="hidden" name="month" value="{{ month }}">
          <input type="hidden" name="client" value="{{ client_id }}">
          <input type="hidden" name="trainer" value="{{ trainer_id }}">
          <input type="hidden" name="status" value="{{ status }}">

          <input class="input" type="text" name="q" value="{{ q }}"
                 placeholder="üîé R√©f / formation / client / formateur‚Ä¶">
          <button class="btn" type="submit">OK</button>

          <a class="btn btn--ghost"
             href="{% url 'trainings:training_manage_home' %}?month={{ month|urlencode }}&client={{ client_id|urlencode }}&trainer={{ trainer_id|urlencode }}&status={{ status|urlencode }}">
            Effacer
          </a>
        </form>

        <!-- Mois -->
        <div class="monthbar">
          <a class="pill pill--sm {% if not month %}pill--active{% endif %}"
             href="{% url 'trainings:training_manage_home' %}?client={{ client_id|urlencode }}&trainer={{ trainer_id|urlencode }}&status={{ status|urlencode }}&q={{ q|urlencode }}">
            Tous
          </a>

          {% for m in months %}
            {% with mv=m.value|default:m %}
              {% with mm=mv|slice:"5:7" %}
                <a class="pill pill--sm {% if month == mv %}pill--active{% endif %}"
                   href="{% url 'trainings:training_manage_home' %}?month={{ mv|urlencode }}&client={{ client_id|urlencode }}&trainer={{ trainer_id|urlencode }}&status={{ status|urlencode }}&q={{ q|urlencode }}">
                  {% if m.label %}
                    {{ m.label }}
                  {% else %}
                    {% if mm == "01" %}JAN{% elif mm == "02" %}FEV{% elif mm == "03" %}MAR{% elif mm == "04" %}AVR{% elif mm == "05" %}MAI{% elif mm == "06" %}JUN{% elif mm == "07" %}JUL{% elif mm == "08" %}AOU{% elif mm == "09" %}SEP{% elif mm == "10" %}OCT{% elif mm == "11" %}NOV{% elif mm == "12" %}DEC{% endif %}
                  {% endif %}
                </a>
              {% endwith %}
            {% endwith %}
          {% endfor %}
        </div>

        <!-- ‚úÖ 3 menus c√¥te √† c√¥te -->
        <div class="filters-row">
          <!-- Client -->
          <form method="get" style="margin:0;">
            <input type="hidden" name="month" value="{{ month }}">
            <input type="hidden" name="trainer" value="{{ trainer_id }}">
            <input type="hidden" name="status" value="{{ status }}">
            <input type="hidden" name="q" value="{{ q }}">
            <select class="select" name="client" onchange="this.form.submit()">
              <option value="">‚Äî Tous les clients ‚Äî</option>
              {% for c in clients %}
                <option value="{{ c.id }}" {% if client_id|stringformat:"s" == c.id|stringformat:"s" %}selected{% endif %}>{{ c }}</option>
              {% endfor %}
            </select>
          </form>

          <!-- Formateur -->
          <form method="get" style="margin:0;">
            <input type="hidden" name="month" value="{{ month }}">
            <input type="hidden" name="client" value="{{ client_id }}">
            <input type="hidden" name="status" value="{{ status }}">
            <input type="hidden" name="q" value="{{ q }}">
            <select class="select" name="trainer" onchange="this.form.submit()">
              <option value="">‚Äî Tous les formateurs ‚Äî</option>
              {% for t in trainers %}
                <option value="{{ t.id }}" {% if trainer_id|stringformat:"s" == t.id|stringformat:"s" %}selected{% endif %}>{{ t }}</option>
              {% endfor %}
            </select>
          </form>

          <!-- Statut -->
          <form method="get" style="margin:0;">
            <input type="hidden" name="month" value="{{ month }}">
            <input type="hidden" name="client" value="{{ client_id }}">
            <input type="hidden" name="trainer" value="{{ trainer_id }}">
            <input type="hidden" name="q" value="{{ q }}">
            <select class="select" name="status" onchange="this.form.submit()">
              <option value="" {% if not status %}selected{% endif %}>‚Äî Tous les statuts ‚Äî</option>
              <option value="upcoming" {% if status == "upcoming" %}selected{% endif %}>√Ä venir</option>
              <option value="ongoing" {% if status == "ongoing" %}selected{% endif %}>En cours</option>
              <option value="done" {% if status == "done" %}selected{% endif %}>Termin√©e</option>
            </select>
          </form>
        </div>

      </div>

      <!-- LISTE SESSIONS -->
      <div class="scroll" style="padding:12px; display:flex; flex-direction:column; gap:8px;">
        {% for s in sessions %}
          <a class="srow {% if selected_session and selected_session.id == s.id %}srow--active{% endif %}"
             href="{% url 'trainings:training_manage_home' %}?month={{ month|urlencode }}&client={{ client_id|urlencode }}&trainer={{ trainer_id|urlencode }}&status={{ status|urlencode }}&q={{ q|urlencode }}&session={{ s.id }}">
            <div style="min-width:0;">
              <div class="sname" style="display:flex; gap:10px; align-items:center;">
                <span style="min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                  {{ s.reference|default:"Session" }} ‚Äî {{ s.training }}
                </span>
                <span class="countbadge">üë• {{ participants_count_by_session|get_item:s.id }}</span>
              </div>

              <div class="smeta">
                <span>üìÖ {{ s.start_date|date:"d/m/Y" }}{% if s.end_date %} ‚Üí {{ s.end_date|date:"d/m/Y" }}{% endif %}</span>

                {% if s.end_date and s.end_date < today %}
                  <span class="tag tag--danger">Termin√©e</span>
                {% elif s.start_date > today %}
                  <span class="tag tag--ok">√Ä venir</span>
                {% else %}
                  <span class="tag tag--warning">En cours</span>
                {% endif %}

                {% if s.client %}<span>‚Ä¢ üè¢ {{ s.client }}</span>{% endif %}
                {% if s.trainer %}<span>‚Ä¢ üë§ {{ s.trainer }}</span>{% endif %}
              </div>
            </div>
            <div style="opacity:.7;">‚Üí</div>
          </a>
        {% empty %}
          <div style="opacity:.65; padding:10px 4px;">Aucune session trouv√©e.</div>
        {% endfor %}
      </div>
    </div>

    <!-- COL DROITE -->
    <div class="panel">
      <div class="ph">
        <div>
          <div style="font-size:18px; font-weight:950;">
            üë• Participants
            {% if selected_session %}<span class="small" style="font-weight:900;">({{ registrations|length }})</span>{% endif %}
          </div>
          {% if selected_session %}
            <div class="small">{{ selected_session.reference }} ‚Ä¢ {{ selected_session.start_date|date:"d/m/Y" }}</div>
          {% else %}
            <div class="small">S√©lectionne une session √† gauche</div>
          {% endif %}
        </div>

        {% if selected_session %}
          <div style="display:flex; gap:10px; align-items:center;">
            <a class="btn btn--ghost" href="{% url 'trainings:export_participants_csv' selected_session.id %}">‚¨áÔ∏è Export CSV</a>

            <a class="btn"
               href="{% url 'trainings:training_manage_home' %}?month={{ month|urlencode }}&client={{ client_id|urlencode }}&trainer={{ trainer_id|urlencode }}&status={{ status|urlencode }}&q={{ q|urlencode }}&session={{ selected_session.id }}&drawer=add-participant">
              ‚ûï Ajouter
            </a>
          </div>
        {% endif %}
      </div>

      {% if selected_session %}
        <div style="padding:12px 16px; border-bottom:1px solid rgba(255,255,255,0.08); flex:0 0 auto;">
          <input id="pSearch" type="text"
                 placeholder="üîç Rechercher un participant (nom ou email)‚Ä¶"
                 style="width:100%; padding:10px 12px; border-radius:12px;
                        background:rgba(0,0,0,0.25);
                        border:1px solid rgba(255,255,255,0.12);
                        color:white; font-weight:900; outline:none;">
        </div>
      {% endif %}

      {% if not selected_session %}
        <div style="padding:16px; opacity:.65;">Aucune session s√©lectionn√©e.</div>
      {% else %}
        <div class="scroll" style="padding:12px; display:flex; flex-direction:column; gap:8px;">
          {% for reg in registrations %}
            <div class="prow" data-search="{{ reg.participant.last_name }} {{ reg.participant.first_name }} {{ reg.participant.email }}">
              <div style="min-width:0; display:flex; gap:10px; align-items:baseline; flex:1;">
                <div class="pname">{{ reg.participant.last_name }} {{ reg.participant.first_name }}</div>
                <div class="pemail">{{ reg.participant.email }}</div>
              </div>

              <div style="display:flex; gap:8px;">
                <a class="iconbtn" href="{% url 'trainings:session_participant_edit' selected_session.id reg.id %}" title="Modifier">‚úèÔ∏è</a>

                <form method="post" action="{% url 'trainings:session_participant_delete' selected_session.id reg.id %}" style="margin:0;">
                  {% csrf_token %}
                  <button class="iconbtn iconbtn--danger" type="submit"
                          onclick="return confirm('Retirer ce participant ?')" title="Retirer">üóëÔ∏è</button>
                </form>
              </div>
            </div>
          {% empty %}
            <div style="opacity:.65; padding:10px 4px;">Aucun participant.</div>
          {% endfor %}
        </div>
      {% endif %}
    </div>

  </div>

  <!-- Drawer (HTML) -->
  <div id="participantDrawerBackdrop" class="drawer-backdrop"
       onclick="closeDrawer('participantDrawer')"></div>

  <div id="participantDrawer" class="drawer" aria-hidden="true">
    <div class="drawer-top">
      <h2>‚ûï Ajouter un participant</h2>
      <button class="xbtn" type="button" onclick="closeDrawer('participantDrawer')">Fermer</button>
    </div>

    <div class="drawer-body">
      {% if selected_session %}
        <div class="small" style="margin-bottom:12px;">
          Session : <strong>{{ selected_session.reference }}</strong> ‚Äî {{ selected_session.start_date|date:"d/m/Y" }}
        </div>

        <form method="post" action="{% url 'trainings:session_participant_add' selected_session.id %}">
          {% csrf_token %}
          {{ p_form.as_p }}

          <div style="display:flex; gap:10px; margin-top:14px;">
            <button class="xbtn" type="submit" style="
              border-color: rgba(124,58,237,0.45);
              background: rgba(124,58,237,0.18);
            ">Enregistrer</button>

            <button class="xbtn" type="button" onclick="closeDrawer('participantDrawer')">Annuler</button>
          </div>
        </form>
      {% else %}
        <div class="small">S√©lectionne une session √† gauche.</div>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
  console.log("‚úÖ manage_sessions_board extra_js charg√©");

  // Recherche participants
  (function(){
    var input = document.getElementById('pSearch');
    if(!input) return;

    input.addEventListener('input', function(){
      var q = (input.value || '').toLowerCase().trim();
      var rows = document.querySelectorAll('.prow[data-search]');
      rows.forEach(function(r){
        var text = (r.getAttribute('data-search') || '').toLowerCase();
        r.style.display = (!q || text.includes(q)) ? '' : 'none';
      });
    });
  })();

  // Auto-open drawer si drawer=add-participant
  document.addEventListener('DOMContentLoaded', function(){
    try{
      var url = new URL(window.location.href);
      if(url.searchParams.get('drawer') === 'add-participant'){
        openDrawer('participantDrawer'); // suppos√©e venir du base.html
      }
    }catch(e){}
  });
</script>
{% endblock %}